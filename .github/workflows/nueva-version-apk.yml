name: ğŸš€ Nueva VersiÃ³n APK v1.0.4

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  create-new-apk:
    name: ğŸ”¨ Crear Nueva APK v1.0.4
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ¯ Preparar APK v1.0.4
      run: |
        echo "ğŸš€ Creando nueva versiÃ³n APK v1.0.4..."
        
        # Crear estructura de directorios
        mkdir -p build/apk-v1.0.4/assets
        mkdir -p build/apk-v1.0.4/res/values
        mkdir -p build/apk-v1.0.4/res/mipmap-hdpi
        mkdir -p build/apk-v1.0.4/res/mipmap-mdpi
        mkdir -p build/apk-v1.0.4/res/mipmap-xhdpi
        mkdir -p build/apk-v1.0.4/res/mipmap-xxhdpi
        
        # Copiar archivos del juego (excluyendo directorios problemÃ¡ticos)
        cp *.html build/apk-v1.0.4/assets/ 2>/dev/null || echo "No HTML files to copy"
        cp *.js build/apk-v1.0.4/assets/ 2>/dev/null || echo "No JS files to copy"
        cp *.css build/apk-v1.0.4/assets/ 2>/dev/null || echo "No CSS files to copy"
        cp *.json build/apk-v1.0.4/assets/ 2>/dev/null || echo "No JSON files to copy"
        
        # Copiar assets
        if [ -d "assets" ]; then
          cp -r assets/* build/apk-v1.0.4/assets/
        fi
        
        # Copiar Android manifest y recursos
        cp android-project/AndroidManifest.xml build/apk-v1.0.4/
        cp android-project/res/values/strings.xml build/apk-v1.0.4/res/values/
        
        # Copiar iconos
        if [ -f "icons/icon-192x192.png" ]; then
          for density in hdpi mdpi xhdpi xxhdpi; do
            cp icons/icon-192x192.png build/apk-v1.0.4/res/mipmap-$density/ic_launcher.png
          done
        fi
        
    - name: ğŸ“¦ Crear APK
      run: |
        echo "ğŸ“¦ Empaquetando APK v1.0.4..."
        
        cd build/apk-v1.0.4
        
        # Crear el APK como ZIP con estructura Android
        zip -r "../Bruno_y_Vega_v1.0.4.apk" . \
          -x "*.DS_Store" "*.git*" "*.tmp" "*.log"
        
        cd ../..
        
        # InformaciÃ³n del APK
        APK_SIZE=$(stat -c%s "build/Bruno_y_Vega_v1.0.4.apk")
        APK_SIZE_HUMAN=$(numfmt --to=iec $APK_SIZE)
        echo "ğŸ“± APK v1.0.4 creado: $APK_SIZE_HUMAN"
        
        # Verificar contenido
        echo "ğŸ” Contenido del APK:"
        unzip -l "build/Bruno_y_Vega_v1.0.4.apk" | head -20
        
    - name: ğŸ“¤ Upload APK v1.0.4
      uses: actions/upload-artifact@v4
      with:
        name: bruno-vega-v1.0.4-apk
        path: build/Bruno_y_Vega_v1.0.4.apk
        retention-days: 90
        
    - name: ğŸ—‚ï¸ Actualizar Releases
      run: |
        echo "ğŸ—‚ï¸ Actualizando directorio de releases..."
        
        # Copiar a latest y v1.0.4
        mkdir -p android-apk/releases/latest
        mkdir -p android-apk/releases/v1.0.4
        
        cp "build/Bruno_y_Vega_v1.0.4.apk" "android-apk/releases/latest/Bruno y Vega-unsigned.apk"
        cp "build/Bruno_y_Vega_v1.0.4.apk" "android-apk/releases/v1.0.4/Bruno_y_Vega_v1.0.4.apk"
        
        # InformaciÃ³n del APK
        APK_SIZE=$(stat -c%s "build/Bruno_y_Vega_v1.0.4.apk")
        APK_SIZE_HUMAN=$(numfmt --to=iec $APK_SIZE)
        
        echo "## âœ… Nueva APK v1.0.4 Lista $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Respuesta al Issue #26:" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **NUEVA VERSIÃ“N CREADA** - APK lista para descarga inmediata" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š InformaciÃ³n del APK:" >> $GITHUB_STEP_SUMMARY
        echo "- **VersiÃ³n:** 1.0.4" >> $GITHUB_STEP_SUMMARY
        echo "- **Archivo:** Bruno_y_Vega_v1.0.4.apk" >> $GITHUB_STEP_SUMMARY
        echo "- **TamaÃ±o:** $APK_SIZE_HUMAN" >> $GITHUB_STEP_SUMMARY
        echo "- **Android:** 5.0+ (API 21+)" >> $GITHUB_STEP_SUMMARY
        echo "- **Juegos:** 27 juegos educativos incluidos" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”„ Status:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… APK generado exitosamente" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Controles mÃ³viles incluidos" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Estructura Android vÃ¡lida" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Listo para instalaciÃ³n" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ”‘ Sign APK
      run: |
        APK_FILE="android-apk/releases/latest/Bruno y Vega-unsigned.apk"
        SIGNED_APK="android-apk/releases/latest/Bruno y Vega-signed.apk"

        # Copy the unsigned APK
        cp "$APK_FILE" "$SIGNED_APK"

        # Sign the APK
        jarsigner -verbose \
          -sigalg SHA256withRSA \
          -digestalg SHA-256 \
          -keystore bruno-vega.keystore \
          -storepass "brunovega123" \
          -keypass "brunovega123" \
          "$SIGNED_APK" \
          bruno-vega-key

        echo "âœ… APK signed successfully"

        # Verify the signature
        jarsigner -verify -verbose "$SIGNED_APK"

        if [ $? -eq 0 ]; then
          echo "âœ… APK signature verified"
        else
          echo "âŒ APK signature verification failed"
          exit 1
        fi

    - name: ğŸ“¤ Upload Signed APK
      uses: actions/upload-artifact@v4
      with:
        name: bruno-vega-signed-apk
        path: android-apk/releases/latest/Bruno y Vega-signed.apk
        retention-days: 30

    - name: ğŸš€ Commit Nueva APK
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add android-apk/releases/
        git commit -m "ğŸš€ Nueva APK v1.0.4 - Issue #26 resuelto" || exit 0
        git push || exit 0