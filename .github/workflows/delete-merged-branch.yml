---
name: ğŸ—‘ï¸ Auto Delete Merged Branch

"on":
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  delete-merged-branch:
    name: ğŸ§¹ Clean Up Merged Branch
    runs-on: ubuntu-latest

    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—‘ï¸ Delete Merged Branch
        run: |
          echo "## ğŸ—‘ï¸ Branch Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get branch information
          BRANCH_NAME="${{ github.head_ref }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          MERGED_BY="${{ github.event.pull_request.merged_by.login }}"

          echo "### ğŸ“‹ Merge Information" >> $GITHUB_STEP_SUMMARY
          echo "- **PR #$PR_NUMBER**: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Merged by**: @$MERGED_BY" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Safety checks before deleting
          if [ -z "$BRANCH_NAME" ]; then
            echo "âŒ **Error**: Could not determine branch name" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Avoid deleting protected branches
          PROTECTED_BRANCHES=("main" "master" "develop" "development")
          for protected in "${PROTECTED_BRANCHES[@]}"; do
            if [ "$BRANCH_NAME" = "$protected" ]; then
              echo "ğŸ›¡ï¸ **Protected**: Branch \`$BRANCH_NAME\` is protected" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
          done

          echo "### ğŸ—‘ï¸ Deletion Process" >> $GITHUB_STEP_SUMMARY

          # Delete the branch
          if git push origin --delete "$BRANCH_NAME"; then
            echo "âœ… **Success**: Branch \`$BRANCH_NAME\` deleted" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ **Clean**: Repository is now cleaner!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed**: Could not delete branch" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ **Note**: Branch might have been already deleted" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- The merged code is now part of \`main\` branch" >> $GITHUB_STEP_SUMMARY
          echo "- Future work should branch from the updated \`main\`" >> $GITHUB_STEP_SUMMARY
          REPO_URL="https://github.com/${{ github.repository }}/tree/main"
          echo "- Check the [main branch]($REPO_URL) for the latest code" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¢ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ github.event.pull_request.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ—‘ï¸ Branch Cleanup Completed

            âœ… The branch \`${{ github.head_ref }}\` has been automatically deleted after merge.

            ğŸ‰ Thanks for your contribution! The code is now part of the \`main\` branch.

            ---
            *This is an automated cleanup to keep the repository tidy. Future branches should be created from the updated \`main\` branch.*`
            });